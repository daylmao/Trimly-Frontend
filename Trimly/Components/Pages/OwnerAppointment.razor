@page "/owner/appointments"
@using Trimly.Core.Application.DTOs.Appointment
@using Trimly.Core.Application.Pagination
@using Trimly.Core.Domain.Enums
@using Trimly.Infrastructure.Api
@inject IAppointmentHttpService _appointmentService
@inject IAuthService AuthService
@inject NavigationManager NavigationManager

<div class="min-h-screen bg-background text-text">
  <div class="flex h-screen overflow-hidden">
    <!-- Sidebar -->
    <aside class="hidden md:flex md:flex-col w-64 bg-surface border-r border-gray-700">
      <!-- Logo -->
      <div class="p-4 border-b border-gray-700">
        <a href="/" class="text-2xl font-bold bg-gradient-to-r from-primary to-secondary bg-clip-text text-transparent">
          Trimly
        </a>
      </div>

      <!-- Navigation -->
      <nav class="flex-1 overflow-y-auto py-4">
        <ul class="space-y-1 px-2">
          <li>
            <a href="/owner-dashboard" class="flex items-center px-4 py-2 text-sm rounded-md hover:bg-gray-700">
              <i class="fas fa-tachometer-alt w-5 h-5 mr-3"></i>
              Dashboard
            </a>
          </li>
          <li>
            <a href="/owner/companies" class="flex items-center px-4 py-2 text-sm rounded-md hover:bg-gray-700">
              <i class="fas fa-store w-5 h-5 mr-3"></i>
              Mis Barberías
            </a>
          </li>
          <li>
            <a href="/owner/barberos" class="flex items-center px-4 py-2 text-sm rounded-md hover:bg-gray-700">
              <i class="fas fa-cut w-5 h-5 mr-3"></i>
              Barberos
            </a>
          </li>
          <li>
            <NavLink href="/owner/schedule" class="flex items-center px-4 py-2 text-sm rounded-md hover:bg-gray-700">
              <i class="fas fa-clock w-5 h-5 mr-3"></i>
              Horarios
            </NavLink>
          </li>
          <li>
            <a href="/owner/appointments" class="flex items-center px-4 py-2 text-sm rounded-md bg-primary/10 text-primary">
              <i class="fas fa-calendar-alt w-5 h-5 mr-3"></i>
              Citas
            </a>
          </li>
          <li>
            <a href="/owner/reviews" class="flex items-center px-4 py-2 text-sm rounded-md hover:bg-gray-700">
              <i class="fas fa-star w-5 h-5 mr-3"></i>
              Reseñas
            </a>
          </li>
        </ul>

        <div class="mt-8 px-4">
          <h3 class="px-2 text-xs font-semibold text-gray-400 uppercase tracking-wider">
            Configuración
          </h3>
          <ul class="mt-2 space-y-1">
            <li>
              <a href="/owner/profile" class="flex items-center px-4 py-2 text-sm rounded-md hover:bg-gray-700">
                <i class="fas fa-user-circle w-5 h-5 mr-3"></i>
                Mi Perfil
              </a>
            </li>
            <li>
              <a href="/owner/settings" class="flex items-center px-4 py-2 text-sm rounded-md hover:bg-gray-700">
                <i class="fas fa-cog w-5 h-5 mr-3"></i>
                Ajustes
              </a>
            </li>
          </ul>
        </div>
      </nav>

      <!-- User -->
      <div class="px-4 py-3 border-t border-gray-800/50 bg-gradient-to-r from-gray-900/50 to-gray-800/20">
        <div class="flex items-center justify-between">
          <div class="relative">
            <div class="w-10 h-10 rounded-full bg-gradient-to-tr from-indigo-500 to-purple-600 flex items-center justify-center shadow-[0_0_12px_-2px_rgba(99,102,241,0.5)] group-hover:shadow-[0_0_16px_-1px_rgba(99,102,241,0.7)] transition-all duration-500">
              <i class="fas fa-user-astronaut text-sm text-white/90"></i>
            </div>
            <div class="absolute -bottom-0.5 -right-0.5 w-3 h-3 rounded-full bg-gradient-to-r from-emerald-400 to-cyan-400 border-2 border-gray-900 animate-pulse"></div>
          </div>

          <div class="flex-1 px-3 overflow-hidden">
            <p class="text-sm font-medium tracking-wide text-gray-100 truncate">
              Mi Cuenta
            </p>
            <p class="text-xs text-purple-300/80 font-medium truncate">
              Propietario
            </p>
          </div>

          <button @onclick="Logout"
                  class="p-2 rounded-full group transition-all duration-300 hover:bg-purple-900/20"
                  title="Cerrar sesión">
            <div class="relative">
              <i class="fas fa-arrow-right-from-bracket text-gray-400 group-hover:text-purple-300 group-hover:scale-110 transition-all duration-300"></i>
              <div class="absolute inset-0 rounded-full opacity-0 group-hover:opacity-100 group-hover:shadow-[0_0_12px_3px_rgba(196,181,253,0.4)] transition-all duration-500"></div>
            </div>
          </button>
        </div>
      </div>
    </aside>

    <!-- Mobile sidebar toggle -->
    <div class="md:hidden fixed bottom-4 right-4 z-50">
      <button id="mobile-menu-button" class="bg-primary text-white p-3 rounded-full shadow-lg">
        <i class="fas fa-bars"></i>
      </button>
    </div>

    <!-- Mobile sidebar (hidden by default) -->
    <div id="mobile-sidebar" class="fixed inset-0 z-40 hidden">
      <div class="absolute inset-0 bg-black bg-opacity-50" id="mobile-sidebar-backdrop"></div>
      <div class="absolute inset-y-0 left-0 w-64 bg-surface transform transition-transform duration-300 -translate-x-full" id="mobile-sidebar-content">
        <!-- Mobile sidebar content (same as desktop) -->
        <!-- Logo -->
        <div class="p-4 border-b border-gray-700 flex justify-between items-center">
          <a href="/" class="text-2xl font-bold bg-gradient-to-r from-primary to-secondary bg-clip-text text-transparent">
            Trimly
          </a>
          <button id="close-mobile-menu" class="text-gray-400 hover:text-white">
            <i class="fas fa-times"></i>
          </button>
        </div>

        <!-- Navigation -->
        <nav class="flex-1 overflow-y-auto py-4">
          <ul class="space-y-1 px-2">
            <li>
              <a href="/owner-dashboard" class="flex items-center px-4 py-2 text-sm rounded-md hover:bg-gray-700">
                <i class="fas fa-tachometer-alt w-5 h-5 mr-3"></i>
                Dashboard
              </a>
            </li>
            <li>
              <a href="/owner/companies" class="flex items-center px-4 py-2 text-sm rounded-md hover:bg-gray-700">
                <i class="fas fa-store w-5 h-5 mr-3"></i>
                Mis Barberías
              </a>
            </li>
            <li>
              <a href="/owner/barberos" class="flex items-center px-4 py-2 text-sm rounded-md hover:bg-gray-700">
                <i class="fas fa-cut w-5 h-5 mr-3"></i>
                Barberos
              </a>
            </li>
            <li>
              <a href="/owner/servicios" class="flex items-center px-4 py-2 text-sm rounded-md hover:bg-gray-700">
                <i class="fas fa-list-alt w-5 h-5 mr-3"></i>
                Servicios
              </a>
            </li>
            <li>
              <a href="/owner/appointments" class="flex items-center px-4 py-2 text-sm rounded-md bg-primary/10 text-primary">
                <i class="fas fa-calendar-alt w-5 h-5 mr-3"></i>
                Citas
              </a>
            </li>
            <li>
              <a href="/owner/reviews" class="flex items-center px-4 py-2 text-sm rounded-md hover:bg-gray-700">
                <i class="fas fa-star w-5 h-5 mr-3"></i>
                Reseñas
              </a>
            </li>
          </ul>

          <div class="mt-8 px-4">
            <h3 class="px-2 text-xs font-semibold text-gray-400 uppercase tracking-wider">
              Configuración
            </h3>
            <ul class="mt-2 space-y-1">
              <li>
                <a href="/owner/profile" class="flex items-center px-4 py-2 text-sm rounded-md hover:bg-gray-700">
                  <i class="fas fa-user-circle w-5 h-5 mr-3"></i>
                  Mi Perfil
                </a>
              </li>
              <li>
                <a href="/owner/settings" class="flex items-center px-4 py-2 text-sm rounded-md hover:bg-gray-700">
                  <i class="fas fa-cog w-5 h-5 mr-3"></i>
                  Ajustes
                </a>
              </li>
            </ul>
          </div>
        </nav>

        <!-- User -->
        <div class="p-4 border-t border-gray-700">
          <div class="flex items-center">
            <img src="https://via.placeholder.com/40" alt="Avatar" class="w-8 h-8 rounded-full mr-3">
            <div>
              <p class="text-sm font-medium">Juan Pérez</p>
              <p class="text-xs text-gray-400">Propietario</p>
            </div>
            <button id="logout-mobile-button" class="ml-auto text-gray-400 hover:text-white">
              <i class="fas fa-sign-out-alt"></i>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Main Content -->
    <div class="flex-1 flex flex-col overflow-hidden">
      <!-- Top Header -->
      <header class="bg-surface/80 backdrop-blur-md shadow-md z-10">
        <div class="px-4 py-4 flex justify-between items-center">
          <div>
            <h1 class="text-xl font-semibold">Gestión de Citas</h1>
            <p class="text-sm text-gray-400">Administra las citas de tus barberías</p>
          </div>

          <div class="flex items-center space-x-4">
            <!-- Aquí puedes añadir elementos adicionales en el header si es necesario -->
          </div>
        </div>
      </header>

      <!-- Main Content Area -->
      <main class="flex-1 overflow-y-auto bg-background p-4">
        <!-- Resumen de citas -->

        <!-- Tabla de citas -->
        <div class="overflow-x-auto">
          <table class="w-full">
            <thead>
            <tr class="bg-gray-800">
              <th class="px-4 py-3 text-left text-sm font-medium">Cliente</th>
              <th class="px-4 py-3 text-left text-sm font-medium">Fecha y Hora</th>
              <th class="px-4 py-3 text-left text-sm font-medium">Estado</th>
            </tr>
            </thead>
            <tbody class="divide-y divide-gray-700">
            @if (pagedAppointments.Items.Any())
            {
            foreach (var appointment in pagedAppointments.Items)
            {
            <tr class="hover:bg-gray-800/50 group">
              <td class="px-4 py-3">
                <div class="flex items-center">
                  <div class="relative">
                    <div class="w-10 h-10 rounded-full bg-gradient-to-tr from-indigo-500 to-purple-600 flex items-center justify-center shadow-[0_0_12px_-2px_rgba(99,102,241,0.5)] group-hover:shadow-[0_0_16px_-1px_rgba(99,102,241,0.7)] transition-all duration-500">
                      <i class="fas fa-user-astronaut text-sm text-white/90"></i>
                    </div>
                    <div class="absolute -bottom-0.5 -right-0.5 w-3 h-3 rounded-full bg-gradient-to-r from-emerald-400 to-cyan-400 border-2 border-gray-900 animate-pulse"></div>
                  </div>
                </div>
              </td>
              <td class="px-4 py-3">
                <div>
                  <p class="font-medium">@appointment.StartDateTime?.ToString("dd/MM/yyyy")</p>
                  <p class="text-sm text-gray-400">@appointment.StartDateTime?.ToString("hh:mm tt")</p>
                </div>
              </td>
              <td class="px-4 py-3">
                @{
                var statusClass = appointment.AppointmentStatus switch
                {
                AppointmentStatus.Confirmed => "bg-green-900/30 text-green-500",
                AppointmentStatus.Pending => "bg-yellow-900/30 text-yellow-500",
                AppointmentStatus.Cancelled => "bg-red-900/30 text-red-500",
                _ => "bg-gray-900/30 text-gray-500"
                };

                var statusText = appointment.AppointmentStatus switch
                {
                AppointmentStatus.Confirmed => "Confirmada",
                AppointmentStatus.Pending => "Pendiente",
                AppointmentStatus.Cancelled => "Cancelada",
                _ => "Indefinido"
                };
                }
                <span class="px-3 py-1 @statusClass rounded-full text-xs font-medium">@statusText</span>
              </td>
            </tr>
            }
            }
            else
            {
            <tr>
              <td colspan="3" class="px-4 py-3 text-center text-gray-400">No hay citas disponibles</td>
            </tr>
            }
            </tbody>
          </table>
        </div>
        
        <!-- Paginación -->
        
      </main>
    </div>
  </div>
</div>

  @code {
    private PagedResponse<AppointmentDTos> pagedAppointments = new();
    private int currentPage = 1;
    private int pageSize = 10;
    private int totalPages = 1;
    private bool isProcessing = false;
    private Guid? currentProcessingId = null;
    private System.Threading.Timer refreshTimer;
    
    protected override async Task OnInitializedAsync()
    {
        await LoadAppointments();
        refreshTimer = new System.Threading.Timer(async _ => 
        {
            await InvokeAsync(async () =>
            {
                await LoadAppointments();
                StateHasChanged();
            });
        }, null, 60000, 60000); // Actualiza cada minuto
    }
    
    private async Task LoadAppointments()
    {
        var response = await _appointmentService.PaginationAppointmentsAsync(
            pageNumber: currentPage,
            pageSize: pageSize);

        if (response.Success)
        {
            pagedAppointments = new PagedResponse<AppointmentDTos>
            {
                Items = new List<AppointmentDTos>(response.Data.Items), 
                TotalCount = response.Data.TotalCount,
                PageNumber = response.Data.PageNumber,
                PageSize = response.Data.PageSize
            };
            
            totalPages = (int)Math.Ceiling((double)pagedAppointments.TotalCount / pageSize);
        }
        else
        {
            pagedAppointments = new PagedResponse<AppointmentDTos>();
            totalPages = 1;
        }
        StateHasChanged();
    }
    
    private async Task Logout()
    {
      await AuthService.LogoutAsync();
      NavigationManager.NavigateTo("/login");
    }
  }